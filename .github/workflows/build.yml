name: Build AvScan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Disable Spectre Mitigation (Filter)
      shell: pwsh
      run: |
        $path = "filter\avscan.vcxproj"
        (Get-Content $path).Replace("<SpectreMitigation>Enable</SpectreMitigation>", "<SpectreMitigation>false</SpectreMitigation>") | Set-Content $path
        Write-Host "Disabled Spectre for filter"

    - name: Disable Spectre Mitigation (User)
      shell: pwsh
      run: |
        $path = "user\avscanuser.vcxproj"
        (Get-Content $path).Replace("<SpectreMitigation>Enable</SpectreMitigation>", "<SpectreMitigation>false</SpectreMitigation>") | Set-Content $path
        Write-Host "Disabled Spectre for user"

    # === THAY ĐỔI QUAN TRỌNG BẮT ĐẦU TỪ ĐÂY ===

    - name: Build filter (Driver)
      run: |
        msbuild.exe filter/avscan.vcxproj -p:Configuration=Release -p:Platform=x64 -p:RunInfVerif=false -p:RunSignTool=false
        
    - name: Build user (Application)
      run: |
        msbuild.exe user/avscanuser.vcxproj -p:Configuration=Release -p:Platform=x64

    # === KẾT THÚC THAY ĐỔI ===

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: avscan-binaries
        path: |
          filter/x64/Release/avscan.sys
          filter/avscan.inf
          x64/Release/avscanuser.exe
